import os
import shutil
import tempfile
from contextlib import contextmanager

@contextmanager
def repertoire_temporaire(prefix="temp_"):
    """
    Cr√©e un r√©pertoire temporaire et le supprime automatiquement apr√®s usage.
    
    Args:
        prefix (str): Pr√©fixe pour le nom du r√©pertoire temporaire
        
    Yields:
        str: Chemin du r√©pertoire temporaire cr√©√©
        
    Exemple:
        with repertoire_temporaire() as temp_dir:
            # Utiliser temp_dir pour vos op√©rations
            with open(os.path.join(temp_dir, "fichier.txt"), "w") as f:
                f.write("Contenu temporaire")
            # Le r√©pertoire est automatiquement supprim√© √† la fin du bloc
    """
    temp_dir = None
    try:
        # Cr√©er un r√©pertoire temporaire
        temp_dir = tempfile.mkdtemp(prefix=prefix)
        print(f"üìÅ R√©pertoire temporaire cr√©√© : {temp_dir}")
        
        # Donner le contr√¥le √† l'utilisateur
        yield temp_dir
        
    except Exception as e:
        print(f"‚ùå Erreur dans le r√©pertoire temporaire : {e}")
        raise
    finally:
        # Nettoyage automatique
        if temp_dir and os.path.exists(temp_dir):
            try:
                shutil.rmtree(temp_dir)
                print(f"üßπ R√©pertoire temporaire supprim√© : {temp_dir}")
            except Exception as e:
                print(f"‚ö†Ô∏è  Impossible de supprimer {temp_dir} : {e}")

def utiliser_repertoire_temporaire():
    """Exemple d'utilisation du r√©pertoire temporaire"""
    
    print("=== D√âMONSTRATION R√âPERTOIRE TEMPORAIRE ===\n")
    
    # Utilisation avec le context manager
    with repertoire_temporaire("mon_app_") as temp_dir:
        print(f"1. R√©pertoire actuel : {temp_dir}")
        
        # Cr√©er quelques fichiers
        fichiers = ["config.txt", "data.csv", "log.txt"]
        for fichier in fichiers:
            chemin_fichier = os.path.join(temp_dir, fichier)
            with open(chemin_fichier, "w") as f:
                f.write(f"Contenu du fichier {fichier}\n")
                f.write("Ligne 1\nLigne 2\nLigne 3")
            print(f"2. Fichier cr√©√© : {chemin_fichier}")
        
        # Cr√©er un sous-r√©pertoire
        sous_dir = os.path.join(temp_dir, "sous_dossier")
        os.makedirs(sous_dir)
        print(f"3. Sous-r√©pertoire cr√©√© : {sous_dir}")
        
        # Lister le contenu
        print("\n4. Contenu du r√©pertoire temporaire :")
        for racine, dossiers, fichiers in os.walk(temp_dir):
            niveau = racine.replace(temp_dir, '').count(os.sep)
            indent = ' ' * 2 * niveau
            print(f"{indent}üìÅ {os.path.basename(racine)}/")
            sous_indent = ' ' * 2 * (niveau + 1)
            for fichier in fichiers:
                print(f"{sous_indent}üìÑ {fichier}")
        
        # Simuler un traitement
        print(f"\n5. Simulation de traitement dans {temp_dir}...")
        total_fichiers = sum(len(fichiers) for _, _, fichiers in os.walk(temp_dir))
        print(f"   {total_fichiers} fichiers trait√©s")
        
        print("\n6. Fin du bloc 'with' - suppression automatique imminent...")
    
    # Ici le r√©pertoire est automatiquement supprim√©
    print("\n7. V√©rification que le r√©pertoire est supprim√©...")
    if not os.path.exists(temp_dir):
        print("‚úÖ R√©pertoire temporaire correctement supprim√©")
    else:
        print("‚ùå Le r√©pertoire temporaire n'a pas √©t√© supprim√©")

def exemple_operations_complexes():
    """Exemple avec des op√©rations plus complexes"""
    
    print("\n" + "="*50)
    print("EXEMPLE AVEC TRAITEMENT DE FICHIERS")
    print("="*50)
    
    with repertoire_temporaire("processing_") as temp_dir:
        # Cr√©ation de fichiers de donn√©es
        donnees = {
            "utilisateurs.csv": "id,nom,email\n1,Alice,alice@test.com\n2,Bob,bob@test.com",
            "config.json": '{"app": "test", "version": 1.0}',
            "log.txt": "D√©but du traitement...\n"
        }
        
        for nom_fichier, contenu in donnees.items():
            chemin = os.path.join(temp_dir, nom_fichier)
            with open(chemin, "w") as f:
                f.write(contenu)
            print(f"üìù Fichier de donn√©es cr√©√© : {nom_fichier}")
        
        # Simuler un traitement de donn√©es
        print("\nüîß Simulation de traitement...")
        
        # Lire et traiter les fichiers
        for nom_fichier in os.listdir(temp_dir):
            chemin = os.path.join(temp_dir, nom_fichier)
            taille = os.path.getsize(chemin)
            print(f"   Traitement de {nom_fichier} ({taille} octets)")
        
        # Cr√©er un r√©sultat
        resultat_path = os.path.join(temp_dir, "resultat.txt")
        with open(resultat_path, "w") as f:
            f.write("Traitement termin√© avec succ√®s!\n")
            f.write(f"Fichiers trait√©s: {len(os.listdir(temp_dir))}")
        
        print(f"\nüìä R√©sultat sauvegard√© dans : {resultat_path}")
        
        # Afficher le contenu du r√©sultat
        with open(resultat_path, "r") as f:
            print("Contenu du r√©sultat:")
            for ligne in f:
                print(f"   {ligne.strip()}")

def exemple_avec_exception():
    """Exemple montrant que le r√©pertoire est supprim√© m√™me en cas d'erreur"""
    
    print("\n" + "="*50)
    print("EXEMPLE AVEC ERREUR (nettoyage garanti)")
    print("="*50)
    
    try:
        with repertoire_temporaire("error_test_") as temp_dir:
            print(f"üß™ Test dans : {temp_dir}")
            
            # Cr√©er un fichier
            test_file = os.path.join(temp_dir, "test.txt")
            with open(test_file, "w") as f:
                f.write("Ce fichier sera perdu √† cause de l'erreur")
            
            # Simuler une erreur
            raise ValueError("üí• Erreur simul√©e pendant le traitement!")
            
    except ValueError as e:
        print(f"‚ùå Erreur attrap√©e : {e}")
        print("‚úÖ Le r√©pertoire temporaire a √©t√© nettoy√© malgr√© l'erreur")

if __name__ == "__main__":
    # Ex√©cuter tous les exemples
    utiliser_repertoire_temporaire()
    exemple_operations_complexes()
    exemple_avec_exception()
    
    print("\n" + "="*50)
    print("üéâ TOUS LES EXEMPLES TERMIN√âS")
    print("="*50)
